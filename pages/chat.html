<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Title</title>
        <style>
            .chat-row {
                margin: 50px;
            }

            ul {
                margin: 0;
                padding: 0;
                list-style: none;
            }

            ul li {
                padding: 8px;
                background: #928787;
                margin-bottom: 20px;
            }

            ul li:nth-child(2n-2) {
                background: #c3c5c5;
            }

            .chat-input {
                border: 1px solid lightgray;
                border-top-right-radius: 10px;
                border-top-left-radius: 10px;
                padding: 8px 10px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="row chat-row">
                <div class="chat-content">
                    <ul></ul>
                </div>
                <div class="chat-section">
                    <div class="chat-box">
                        <div
                            class="chat-input bg-white"
                            id="chat_input"
                            contenteditable=""
                        ></div>
                    </div>
                </div>
                <div>
                    <button type="submit" id="send_message">Submit</button>
                </div>
            </div>
        </div>

        <script
            src="https://code.jquery.com/jquery-3.6.1.js"
            integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI="
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdn.socket.io/4.5.4/socket.io.min.js"
            integrity="sha384-/KNQL8Nu5gCHLqwqfQjA689Hhoqgi2S84SNUxC3roTe4EhJ9AfLkp8QiQcU8AMzI"
            crossorigin="anonymous"
        ></script>
        <script src="https://requirejs.org/docs/release/2.3.5/minified/require.js"></script>
        <!--<script type="text/javascript" src="bower_components/crypto-js/crypto-js.js"></script>-->
        <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>-->

        <script src="/js/encoding.js"></script>
        <script src="/js/encoding-indexes.js"></script>
        <script src="/js/converter-wrapper.js"></script>
        <script src="/js/rsa-wrapper.js"></script>
        <script src="/js/aes-wrapper.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"
            integrity="sha256-/H4YS+7aYb9kJ5OKhFYPUjSJdrtV6AeyJOtTkw6X72o="
            crossorigin="anonymous"
        ></script>
        <script>
            var serverPubKey = "";
            var clientprivatekey = `-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCc9Dr6+qcjClgs
2YzQO8+NZihpkdXqtbgdyh+rKNQ7yvNBISZ+BP6q5PM+w1ycCodULsgZp+ia7xjz
bBfok8phkef6y3xmh6EguBlIEzrLVAhVd0GdBy35Hf+jUZztMwxhWOT5SsVPs8ei
7sDCZMxNGJL9m9JFWhJezcDEwJSfVXzcU/rzIowOrYjzZY4RKgBaoa5iawjGTYRd
VoYG2MzBEizYTNbPwhN+Y5zOX5AAffVIMJIgnFZuQQeinMcmcRb32nsjc/VyvXsk
QoaFY7WfHZarpfg4LpjkxoHrgzOykNM0PmDPA81OJtzDez/n2j4VXbZ2uELDKVTG
5ZSFqQ8tAgMBAAECggEBAJKTs5E4DGa4/mfEM7E0ajzPLuaIf5JWar/HR5P86Vd9
zXcBkoUV/Q90CYaPxCkl3AROPClZme03ZcHPLPTTMKm2LUMWTfMiruNzioi5DKte
qvnGCcywK8r+rQLE8RzEE8fF0PDPVz170/Dhr7rbj8BgNsYJg3GpEIbg+CnHAAVb
xMeIpi8jw3mM0QzRcWT0jma1hGz26tA52Vml+6P+W+Alq+BF42izuyvEsWHsggM1
P8E63g9X4hEBmRXpl3iZQmPLzXIErqByaDO+DPeD8bEo8t0mcbdx8SDyDVhUcdAR
SWh6RIk+dZ5R4cTdzf6gQv+2+Mpjzhk/+3r/sVDeQgECgYEA3ItAExCWxLv7mYdZ
d8dyjC6np8DJuhz+ELBkTyovjDWx4gMskqxpGR4USiv9tvWF8qyodV0seuvFFv4v
tCe+5HWtcEcSCDq9uany3fjdBP0dqwOZr/9bHQ+KCER7NVOfFNh3MXIcTehRku3P
sH7Jw3UpC1/O8OOy/60DgdffFM0CgYEAti/cYqhMKBshYsZmir3wMOqgQFe7ebJo
wli1bOlNJh2l8W5XLayg41tGP/OepfbpV2xKD2+1DPq2ymoGH3vXJLfBhjXeDPxu
vv4bp9s9ycqgydFVnlhMZVFZhvogVAOuS4bYR5/zB69ItvnLRSPWzPm9z0XW1IDs
e7QhB7e+4+ECgYBI+Hn21OJNrbUNk07y5rbr0vP9+TfFsJoPg41s9BRPW+TDVzGE
Ri9v9BfagrursYjkRmRmkLGK6j+H4AqAnTX3+UetgpZgyq7Do4uMDi9y2xzZ3JMZ
PHA1KVMOcToi5swX5ZdqcMsUq+1xo+W4C/tOBJHUBZs+8Nfk6KXkbDyPcQKBgHrC
xT21KZvcrCJijbXvRmmvr0ur0ieuj+hk3dsFWXbVg3urXhLov4BzgGKXRc+PEKxX
y4+bNeQJDCJYTsfoKpATQdOteHJHplgL4Za5pGjUoINdCtQnq1KZ/jl1UVNLJ6a8
tf+NR7Vl5xlkOBPekl6L6dpAtQF73d19AsSwi3ABAoGAdU9Wvtpz4db/4s6b0+ne
PfoiCH21sJuKr1jfmu+0q45oJHKrCiGRnwNXq2spoTb2ppSQ+bz74dUVkyB3ECVt
utElkhuhXWabNYWWi2rNlZzlluBZZ/py9g9b3SlX4lSCLuYG2bPRxovXifLRKzyH
E/EU7a/N+d7ygpzh192LNeo=
-----END PRIVATE KEY-----`;
            $(document).ready(function () {
                
                var sessionKey = "22bAU9N13jFaKIKJDrudFt3vZ";
                var chat_id = window.localStorage.getItem("current_chat_id");
                let socket = io("http://localhost:8000", {
                    autoConnect: false,
                });
                socket.auth = { phone: window.localStorage.getItem("phone") };
                socket.connect();
                function generateKeys(){

                    const [public,private]=window.crypto.subtle.generateKey()
                    window.localStorage.setItem("private",private)
                    socket.emit("publicKey",public)
                }
                socket.on("connection");
                socket.emit("getPubKey", {
                    phone: window.localStorage.getItem("phone"),
                });
                socket.emit("getChatHistory", {
                    chat_id: chat_id,
                });

                let chatInput = $("#chat_input");
                $("#send_message").click(function () {
                    let message = chatInput.html();
                    $("#chat_input").empty();
                    console.log("send");
                    var contact = window.localStorage.getItem("contact");
                    var phone = window.localStorage.getItem("phone");
                    var encrypted = CryptoJS.AES.encrypt(message, sessionKey);
                    socket.emit("sendMsdToUser", {
                        phone: phone,
                        contact: contact,
                        chat_id: chat_id,
                        user_id: window.localStorage.getItem("user_id"),
                        message: encrypted.toString(),
                    });
                });
             

                function sign(message){
                var clientprivatekey=window.localStorage.getItem("private")

                var importPromise= rsaWrapper.importPrivateKey(clientprivatekey)
                
                const algorithm = "pkcs8";
                let enc = new TextEncoder();
                let encoded =enc.encode(message);
                importPromise.then((private)=>{
                    console.log("ðŸš€ ~ file: chat.html:132 ~ importPromise.then ~ private", private)


                    let signature =  window.crypto.subtle.sign(
                    algorithm,
                    private,
                    encoded).then((signature)=>{
                            console.log("ðŸš€ ~ file: chat.html:134 ~ encoded).then ~ signature", signature)
                        })
                        message=message+"|"+signature
                        // socket.emit("signature",message)
                    })
                } 
                
                
                

                socket.on("serverPubKey", (pupKey) => {
                    serverPubKey = pupKey;
                    console.log(pupKey);
                    // const sessionKey = "482B4D6251655468";
                    try {
                        rsaWrapper
                            .publicEncrypt(pupKey, sessionKey)
                            .then(function (encrypted) {
                                socket.emit("setSessionKey", {
                                    phone: window.localStorage.getItem("phone"),
                                    encryptedSessionKey: encrypted,
                                });
                            });
                    } catch (e) {
                        console.log(e);
                    }
                });
                socket.on("chatHistory", (history) => {
                    // console.log(history);
                    $(".chat-content ul").empty();
                    history.forEach((message) => {
                        $(".chat-content ul").append(`<li>${message}</li>`);
                    });
                });
                socket.on("sendChatToClient", (message) => {
                    $(".chat-content ul").append(`<li>${message}</li>`);
                });
                socket.on("msgSent", (message) => {
                    var decrypted = CryptoJS.AES.decrypt(message, sessionKey);
                    $(".chat-content ul").append(`<li>${decrypted.toString(CryptoJS.enc.Utf8)}</li>`);
                });
            });
        </script>
    </body>
</html>
